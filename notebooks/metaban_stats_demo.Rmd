---
title: "Descriptive stats using MetaboAnalyst"
output: html_notebook
---

```{r}
# Recreate tutorial at https://www.metaboanalyst.ca with own dataset

library(MetaboAnalystR)

library(dplyr)
library(tidyr)
library(stringr)
```

```{r}
# Define input location and where figures should be saved

test_data_file <- "~/git_repo/data_examples/test.tsv"

analyst_compatible_data <- "~/local_files/local_data/reshaped_metabo.csv"
figure_folder <- "~/local_files/analyst_out/basic_stats"
if(!dir.exists(figure_folder)) dir.create(figure_folder, recursive = TRUE)
```

```{r}
# Reshape the input a little to be in a tidy format

metab_data <- test_data_file %>%
  read.table(sep="\t", stringsAsFactors=FALSE, header=TRUE) %>%
  rename(Metabolite = X, MetaboGroup = X.1) %>%
  pivot_longer(c(-Metabolite, -MetaboGroup)) %>%
  mutate(
    Condition = str_extract(name, 'Condition(A|B)'),
    Replicate = case_when(
      grepl('\\.1', name) ~ 'Batch_2',
      grepl('\\.2', name) ~ 'Batch_3',
      TRUE ~ 'Batch_1'
    ),
    Subject = paste(Condition, Replicate, sep="_")
  ) %>%
  select(-name)

head(metab_data)
```

```{r}
# The metaboAnalyst library needs a bit different input format and needs an input file (data frame is not good enough)

analyst_compatible_data <- "~/local_files/local_data/reshaped_metabo.csv"
  
metab_data %>%
  select(Subject, Condition, Metabolite, value)  %>%
  pivot_wider(names_from=Metabolite) %T>%
  { print(head((.)); . } %>%
  write.csv(analyst_compatible_data, row.names=FALSE)
```

```{r}
# After all the transformations, finally, read the input as a MetaboAnalyst object (mSet)

mSet <- NULL # Have to reset otherwise the app resurrects old instance from global when chunk is rerun
anal.type <- "stat"
msg.vec <- list()

mSet <- InitDataObjects("conc", "stat") %>%
  Read.TextData(analyst_compatible_data, "rowu") %>%
  SanityCheckData()
```

```{r}
# Preprocess and normalize data

mSet <- mSet %>%
  ReplaceMin() %>%
  FilterVariable("iqr", "F", 25) %>%
  PreparePrenormData() %>%
  Normalization("MedianNorm", "LogNorm", "NULL", ratio=FALSE, ratioNum=20)
```

```{r}
# A built-in summary of normalization

img_path <- file.path(figure_folder, "normalization_summary")

mSet <- PlotNormSummary(mSet, img_path, "png")

include_graphics(paste(img_path, "png", sep = "."))
```

```{r}
# A built-in summary of sample normalization

img_path <- file.path(figure_folder, "sample_normalization")

mSet <- PlotSampleNormSummary(mSet, img_path, "png")

include_graphics(paste(img_path, "png", sep = "."))
```

```{r}
# The built-in overview of fold changes

img_path <- file.path(figure_folder, "fold_changes")

mSet <- FC.Anal(mSet, 2.0, 0) %>%
  PlotFC(img_path, "png")

include_graphics(paste(img_path, "png", sep = "."))
```

```{r}
# Biomarker ranking is based on multiple t-tests

img_path <- file.path(figure_folder, "t_tests")

mSet <- Ttests.Anal(mSet, F, 0.05, FALSE, TRUE) %>%
  PlotTT(img_path, "png")

include_graphics(paste(img_path, "png", sep = "."))
```

```{r}
# A standard PCA

img_path <- file.path(figure_folder, "pca")

mSet <- mSet %>%
  PCA.Anal() %>%
  PlotPCAPairSummary(file.path(figure_folder, "pca_pair"), "png", 72, width=NA, 5) %>%
  PlotPCAScree(file.path(figure_folder, "pca_scree"), "png", 72, width=NA, 5) %>%
  PlotPCA2DScore(file.path(figure_folder, "pca_score2d"), "png", 72, width=NA, 1, 2, 0.95, 1, 0) %>%
  PlotPCALoading(file.path(figure_folder, "pca_loading"), "png", 72, width=NA, 1, 2) %>%
  PlotPCABiplot(img_path, "png", 72, width=NA, 1, 2) %>%
  PlotPCA3DScoreImg(file.path(figure_folder, "pca_score3d"), "png", 72, width=NA, 1,2,3, 40)

include_graphics(paste(img_path, "png", sep = "."))
```

```{r}
# Partial least squares regression

img_path <- file.path(figure_folder, "pls")

mSet <- mSet %>%
  PLSR.Anal(reg=TRUE) %>%
  PlotPLSPairSummary(img_path, "png", 72, width=NA, 5) %>%
  PlotPLS2DScore(file.path(figure_folder, "pls_score2d"), "png", 72, width=NA, 1,2,0.95,1,0) %>%
  PlotPLS3DScoreImg(file.path(figure_folderm, "pls_score3d"), "png", 72, width=NA, 1,2,3, 40) %>%
  PlotPLSLoading(file.path(figure_folder", pls_loading"), "png", 72, width=NA, 1, 2)

include_graphics(paste(img_path, "png", sep = "."))
```