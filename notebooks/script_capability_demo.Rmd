---
title: "Metabolomic analysis powered by MetaboAnalyst, made flexible with scripts"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float:
      toc_collapsed: true
---

## Workspace setup

The reason of using wrapper functions instead of directly the native MetaboAnalyst functions is that it provides shortcuts to the most common analysis pipelines we are planning to use.  
Another point is that much of the outputs are saved to a file in the temporary location, without offering a means to modify the figure and limits options for saving different stages of quality control (spams working directory).
Some fundamental figures are recreated as ggplots to enhance the above accessibility to figures.
In addition to figures, data is also converted to a more convenient format, mainly dataframes.

```{r}
# Source scripts that bundle MetaboAnalyst functions

library(DT)

source("../scripts/drive_reader.r", chdir=TRUE)
source("../scripts/descriptive_stats.r", chdir=TRUE)
```

```{r}
# Specify output location and create if not existent

local_folder <- "/home/rstudio/local_files/test_output"
if(!dir.exists(local_folder)) dir.create(local_folder)

test_data_file <- "~/git_repo/data_examples/test.tsv"

print("Test data is given to be:")
print(test_data_file)
```

## Descriptive statistics

### Parse inputs assuming a standarized internal format

```{r}
# Parse test input

metabo_data <-standardize_metabo_data(test_data_file)

datatable(metabo_data)
```



```{r}
read_drive <- function(drive_path){
  
  drive_download(
    drive_path,
    overwrite = TRUE
  )

  data_file <- basename(drive_path)
  
  if(tail(unlist(strsplit(data_file, "\\.")), -1) %in% c("xls", "xlsx")){
    data_table <- readexcel(data_file)
  } else {
    data_table <- read.csv(data_file, sep = "\t", stringsAsFactors = FALSE)
  }
  
  unlink(data_file)

  return(data_table)
  
}
```

```{r}
# Get the actual, sensitive data from Drive - execute this only of you have a key

metabo_data <- read_drive("~/Datasets/faeces vizsgÃ¡lat IBD.xlsx")

datatable(metabo_data)
```

```{r}
# Convert input to an mSet object

mSet <- convert_cc_to_mSet(metabo_data)
```

### Key steps to differential met boudled together

```{r}
# Normalize input data

mSet <- normalize_mSet(mSet)
```

```{r}
# Save normalization report

mSet <- PlotSampleNormSummary(mSet, file.path(local_folder, "sampleNorm"), "pdf")
```

```{r}
# Calculate basic descriptive statistics

stat_results <- calcMetaboStat(mSet)

head(stat_results$data)
```

```{r}
# Show a volcano plot of the results (also save this figure)

p <- plotMetaboVolcano(stat_results)
fig2pdf(p, file.path(local_folder, "example_metabo_volcano"))

p
```


## Pathway analyses


















