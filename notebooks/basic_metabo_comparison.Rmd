---
title: "Basic comparison of metabolomic profiles"
output: html_notebook
---

```{r}
# Recreate tutorial at https://www.metaboanalyst.ca with own dataset
library(MetaboAnalystR)

library(dplyr)
library(tidyr)
library(stringr)
```

```{r}
test_data_file <- "~/git_repo/data_examples/test.tsv"
```

```{r}
metab_data <- test_data_file %>%
  read.table(sep="\t", stringsAsFactors=FALSE, header=TRUE) %>%
  rename(Metabolite = X, MetaboGroup = X.1) %>%
  pivot_longer(c(-Metabolite, -MetaboGroup)) %>%
  mutate(
    Condition = str_extract(name, 'Condition(A|B)'),
    Replicate = case_when(
      grepl('\\.1', name) ~ 'Batch_2',
      grepl('\\.2', name) ~ 'Batch_3',
      TRUE ~ 'Batch_1'
    ),
    Subject = paste(Condition, Replicate, sep="_")
  ) %>%
  select(-name)

head(metab_data)
```

```{r}
analyst_compatible_data <- "~/local_files/local_data/reshaped_metabo.csv"
  
metab_data %>%
  select(-MetaboGroup, -Replicate)  %>%
  select(Subject, Condition, Metabolite, value)  %>%
  pivot_wider(names_from=Metabolite) %>%
  write.csv(analyst_compatible_data, row.names=FALSE)
```

```{r}
mSet <- NULL # Have to reset otherwise the app resurrects old instance from global when chunk is rerun
anal.type <- "msetquea"
msg.vec <- list()
mSet <- InitDataObjects("conc", "msetquea") %>%
  Read.TextData(analyst_compatible_data, "rowu") %>%
  SanityCheckData()
```

```{r}
# Preprocess data
mSet <- mSet %>%
  ReplaceMin() %>%
  FilterVariable("iqr", "F", 25) %>%
  PreparePrenormData() %>%
  Normalization("MedianNorm", "LogNorm", "NULL", ratio=FALSE, ratioNum=20)
```

```{r}
mSet <- PlotNormSummary(mSet, "norm_0_", "png", 72, width=NA)
mSet <- PlotSampleNormSummary(mSet, "snorm_0_", "png", 72, width=NA)
```

```{r}
mSet <- FC.Anal.unpaired(mSet, 2.0, 0)
mSet <- PlotFC(mSet, "fc_0_", "png", 72, width=NA)
```

```{r}
mSet <- Ttests.Anal(mSet, F, 0.05, FALSE, TRUE)
mSet <- PlotTT(mSet, "tt_0_", "png", 72, width=NA)
```

```{r}
mSet <- mSet %>%
  PCA.Anal() %>%
  PlotPCAPairSummary("pca_pair_0_", "png", 72, width=NA, 5) %>%
  PlotPCAScree("pca_scree_0_", "png", 72, width=NA, 5) %>%
  PlotPCA2DScore("pca_score2d_0_", "png", 72, width=NA, 1,2,0.95,1,0) %>%
  PlotPCALoading("pca_loading_0_", "png", 72, width=NA, 1,2) %>%
  PlotPCABiplot("pca_biplot_0_", "png", 72, width=NA, 1,2) %>%
  PlotPCA3DScoreImg("pca_score3d_0_", "png", 72, width=NA, 1,2,3, 40)
```

```{r}
mSet <- mSet %>%
  PLSR.Anal(reg=TRUE) %>%
  PlotPLSPairSummary("pls_pair_0_", "png", 72, width=NA, 5) %>%
  PlotPLS2DScore("pls_score2d_0_", "png", 72, width=NA, 1,2,0.95,1,0) %>%
  PlotPLS3DScoreImg("pls_score3d_0_", "png", 72, width=NA, 1,2,3, 40) %>%
  PlotPLSLoading("pls_loading_0_", "png", 72, width=NA, 1, 2) %>%
  PLSDA.CV("L",5, "Q2") %>%
  PlotPLS.Classification("pls_cv_0_", "png", 72, width=NA) %>%
  PlotPLS.Imp("pls_imp_0_", "png", 72, width=NA, "vip", "Comp. 1", 15, FALSE)
```
