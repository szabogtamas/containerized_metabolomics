---
title: "Basic comparison of metabolomic profiles"
output: html_notebook
---

```{r}
# Recreate tutorial at https://www.metaboanalyst.ca with own dataset
library(MetaboAnalystR)

library(dplyr)
library(tidyr)
library(stringr)
```

```{r}
test_data_file <- "data_examples/test.tsv"
```

```{r}
metab_data <- test_data_file %>%
  read.table(sep="\t", stringsAsFactors=FALSE, header=TRUE) %>%
  rename(Metabolite = X, MetaboGroup = X.1) %>%
  pivot_longer(c(-Metabolite, -MetaboGroup)) %>%
  mutate(
    Condition = str_extract(name, 'Condition(A|B)'),
    Replicate = case_when(
      grepl('\\.1', name) ~ 'Batch_2',
      TRUE ~ 'Batch_1'
    )
  ) %>%
  select(-name)

head(metab_data)
```

```{r}
mSet <- InitDataObjects("conc", "msetquea", FALSE)  %>%
  ReadIndData(metab_data)
```

```{r}
# Perform data processing - Data checking
mSet <- SanityCheckData(mSet)
```

```{r}
# Perform data processing - Minimum Value Replacing
mSet <- ReplaceMin(mSet)
```

```{r}
# Perform data processing - Variable Filtering and Normalization
mSet <- FilterVariable(mSet, "iqr", "F", 25)
mSet <- PreparePrenormData(mSet)
mSet <- Normalization(mSet, "MedianNorm", "LogNorm", "NULL", ratio=FALSE, ratioNum=20)
```

```{r}
mSet <- PlotNormSummary(mSet, "norm_0_", "png", 72, width=NA)
mSet <- PlotSampleNormSummary(mSet, "snorm_0_", "png", 72, width=NA)
```

```{r}
mSet <- FC.Anal.unpaired(mSet, 2.0, 0)
mSet <- PlotFC(mSet, "fc_0_", "png", 72, width=NA)
```

```{r}
mSet <- Ttests.Anal(mSet, F, 0.05, FALSE, TRUE)
mSet <- PlotTT(mSet, "tt_0_", "png", 72, width=NA)
```

```{r}
mSet <- mSet %>%
  PCA.Anal() %>%
  PlotPCAPairSummary("pca_pair_0_", "png", 72, width=NA, 5) %>%
  PlotPCAScree("pca_scree_0_", "png", 72, width=NA, 5) %>%
  PlotPCA2DScore("pca_score2d_0_", "png", 72, width=NA, 1,2,0.95,1,0) %>%
  PlotPCALoading("pca_loading_0_", "png", 72, width=NA, 1,2) %>%
  PlotPCABiplot("pca_biplot_0_", "png", 72, width=NA, 1,2) %>%
  PlotPCA3DScoreImg("pca_score3d_0_", "png", 72, width=NA, 1,2,3, 40)
```
