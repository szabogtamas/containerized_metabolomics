---
title: "Pathway analysis using MetaboAnalyst"
output: html_notebook
---

```{r}
# Based on tutorials at https://drive.google.com/file/d/1CXluzyYqNoPqu1DI3HwvDAmRVGMe825m/view and https://drive.google.com/file/d/1bLHQC8G7n9XyBG4Vim63hhICb4Qtw36M/view

library(MetaboAnalystR)

library(dplyr)
library(tidyr)
library(stringr)
```

```{r}
# Define input location and where figures should be saved

test_data_file <- "~/git_repo/data_examples/test.tsv"

analyst_compatible_data <- "~/local_files/local_data/reshaped_metabo.csv"
figure_folder <- "~/local_files/analyst_out/basic_stats"
if(!dir.exists(figure_folder)) dir.create(figure_folder, recursive = TRUE)
```

## Preprocessing steps

```{r}
# Reshape the input a little to be in a tidy format

metab_data <- test_data_file %>%
  read.table(sep="\t", stringsAsFactors=FALSE, header=TRUE) %>%
  rename(Metabolite = X, MetaboGroup = X.1) %>%
  pivot_longer(c(-Metabolite, -MetaboGroup)) %>%
  mutate(
    Condition = str_extract(name, 'Condition(A|B)'),
    Replicate = case_when(
      grepl('\\.1', name) ~ 'Batch_2',
      grepl('\\.2', name) ~ 'Batch_3',
      TRUE ~ 'Batch_1'
    ),
    Subject = paste(Condition, Replicate, sep="_")
  ) %>%
  select(-name)

head(metab_data)
```

```{r}
# The metaboAnalyst library needs a bit different input format and needs an input file (data frame is not good enough)

analyst_compatible_data <- "~/local_files/local_data/reshaped_metabo.csv"
  
metab_data %>%
  select(Subject, Condition, Metabolite, value)  %>%
  pivot_wider(names_from=Metabolite) %T>%
  { print(head((.)); . } %>%
  write.csv(analyst_compatible_data, row.names=FALSE)
```

```{r}
# After all the transformations, finally, read the input as a MetaboAnalyst object (mSet)

mSet <- NULL # Have to reset otherwise the app resurrects old instance from global when chunk is rerun
anal.type <- "stat"
msg.vec <- list()

mSet <- InitDataObjects("conc", "stat") %>%
  Read.TextData(analyst_compatible_data, "rowu") %>%
  SanityCheckData()
```

```{r}
# Normalize data

mSet <- mSet %>%
  ReplaceMin() %>%
  FilterVariable("iqr", "F", 25) %>%
  PreparePrenormData() %>%
  Normalization("MedianNorm", "LogNorm", "NULL", ratio=FALSE, ratioNum=20)
```

## Hitlist-based approach


```{r}
# Select top compounds based on t-tests

mSet <- FC.Anal(mSet, 2.0, 0) %>%
  Ttests.Anal(F, 0.05, FALSE, TRUE)

significance_table <- mSet$analSet$tt$sig.mat %>%
  data.frame(compound = rownames(.), .) %>%
  arrange(p.value)

head(significance_table)
selected_compounds <- significance_table[1:50, "compound"]
```

```{r}
# Parse the hitlist

mSet <- NULL
mSet <- InitDataObjects("conc", "msetora", FALSE) %>%
  Setup.MapData(selected_compounds) %>%
  CrossReferencing("name")

mSet$name.map
```

```{r}
# Run the ORA pipeline

img_path <- file.path(figure_folder, "ora")

mSet <- mSet %>%
  CreateMappingResultTable() %>%
  PerformDetailMatch("L-Isolucine") %>%
  GetCandidateList() %>%
  SetCandidate("L-Isolucine", "L-Isoleucine") %>%
  SetMetabolomeFilter(FALSE) %>%
  SetCurrentMsetLib("smpdb_pathway", 2) %>%
  CalculateHyperScore() %>%
  PlotORA(mSet, img_path, "bar", "png")

include_graphics(paste(img_path, "png", sep = "."))
```

## Pathway-focused approach

```{r}
# Go back to the hitlist

mSet <- NULL
mSet <- InitDataObjects("conc", "pathora", FALSE) %>%
  Setup.MapData(selected_compounds) %>%
  CrossReferencing("name") %>%
  CreateMappingResultTable()

mSet$dataSet$map.table
```

```{r}
# Run the PATHORA pipeline

img_path <- file.path(figure_folder, "path_view")

mSet <- mSet %>%
  SetKEGG.PathLib("hsa", "current") %>%
  SetMetabolomeFilter(mSet, FALSE) %>%
  CalculateOraScore("rbc", "hyperg") %>%
  PlotPathSummary(img_path, "png")

include_graphics(paste(img_path, "png", sep = "."))
```

```{r}
# Plot a specific metabolic pathway, in this case "Glycine, serine and threonine metabolism"

img_path <- file.path(figure_folder, "Glycine, serine and threonine metabolism")

mSet <- mSet %>%
  PlotKEGGPath(img_path, 528, 480, "png", NULL)

include_graphics(paste(img_path, "png", sep = "."))
```

## Demonstrate mSEA approach

```{r}
# Initialize the mSet object agian

mSet <- NULL # Have to reset otherwise the app resurrects old instance from global when chunk is rerun
anal.type <- "stat"
msg.vec <- list()

mSet <- InitDataObjects("conc", "msetqea") %>%
  Read.TextData(analyst_compatible_data, "rowu") %>%
  CrossReferencing("name") %>%
  CreateMappingResultTable() %>%
  SanityCheckData()
```

```{r}
# Normalize data

mSet <- mSet %>%
  ReplaceMin(mSet) %>%
  PreparePrenormData() %>%
  Normalization("NULL", "NULL", "NULL", "PIF_178", ratio=FALSE, ratioNum=20)
```

```{r}
# Run the mSEA pipeline

img_path <- file.path(figure_folder, "msea")

mSet <- mSet %>%
  SetMetabolomeFilter(FALSE) %>%
  SetCurrentMsetLib("smpdb_pathway", 2) %>%
  CalculateGlobalTestScore() %>%
  PlotQEA.Overview("img_path, "bar", "png")

include_graphics(paste(img_path, "png", sep = "."))
```