---
title: "Scratch notebook to test and develop Pathway funtcions"
output: html_notebook
---

```{r}
# Based on tutorials at https://drive.google.com/file/d/1CXluzyYqNoPqu1DI3HwvDAmRVGMe825m/view and https://drive.google.com/file/d/1bLHQC8G7n9XyBG4Vim63hhICb4Qtw36M/view

library(MetaboAnalystR)

library(dplyr)
library(tidyr)
library(stringr)
library(googledrive)
library(readxl)
library(tibble)
library(ggplot2)
```

```{r}
# Specify output location and create if not existent

local_folder <- "~/local_files/test_output"
if(!dir.exists(local_folder)) dir.create(local_folder)

test_data_file <- "~/git_repo/data_examples/test.tsv"
drive_auth(cache = "/home/rstudio/local_files/.secrets", email = TRUE)

read_drive <- function(drive_path){
  
  drive_download(
    drive_path,
    overwrite = TRUE
  )

  data_file <- basename(drive_path)
  
  if(tail(unlist(strsplit(data_file, "\\.")), -1) %in% c("xls", "xlsx")){
    data_table <- read_excel(data_file)
  } else {
    data_table <- read.csv(data_file, sep = "\t", stringsAsFactors = FALSE)
  }
  
  unlink(data_file)

  return(data_table)
  
}

metabo_data <- "~/Datasets/faeces vizsgÃ¡lat IBD standard.xlsx" %>%
  read_drive() %>%
  pivot_longer(-one_of("Metabolite", "Group")) %>%
  rename(MetaboGroup = Group, Subject = name) %>%
  mutate(
    Condition = gsub("\\d+_", "", Subject),
    Replicate = paste0(stringr::str_extract(Subject, "\\d+_"), "Batch")
  ) %>%
  filter(Condition %in% c("CTRL", "Friss_UC"))

head(metabo_data)
```

```{r}
top_stat_m <- c(
  'PEA', 'Histamine', 'Serotonin', 'Carnosine', 'BABA', 'CDCA',
  'Anserine', 'CA', 'Kynurenine', '3-IAA', 'Taurine', 'His',
  'AA', 'DHA', 'Trigonelline', 'Gly'
)

top_roc_m <- c(
  'DG(18:2_20:0)', 'SM C16:1', 'SM C26:1', 'TG(20:1_31:0)', 'PC ae C34:0', 'AA',
  'SM C24:1', 'DG(18:1_20:0)', 'Histamine', 'SM C16:0', 'PEA', 'DG(22:1_22:2)',
  'ProBetaine', 'alpha-AAA', 'SM (OH) C24:1', 'CE(20:4)', 'TG(18:2_33:2)',
  'DG(16:1_20:0)', 'DG(16:1_18:2)', 'SM (OH) C22:2', 'Hex2Cer(d18:1/24:1)',
  'Hex2Cer(d18:1/26:1)', 'lysoPC a C18:0', 'PC ae C32:1', 'DHA', 'p-Cresol-SO4',
  'Hex2Cer(d18:1/14:0)', 'TG(18:2_35:1)', 'Hex2Cer(d18:1/16:0)', 'TG(16:0_36:5)', 
  'PC aa C30:0', 'Carnosine', 'Hex2Cer(d18:1/22:0)', 'FA(18:2)', 'C16', 'SM (OH) C14:1',
  'SM (OH) C16:1', 'SM (OH) C22:1', 'PC aa C32:0', 'SM C24:0', 'TG(16:1_34:3)',
  'Spermidine', 'Cer(d18:2/24:1)', 'DG(18:1_20:1)', 'TG(18:1_36:5)', 'DG(18:2_18:3)',
  'Hex2Cer(d18:1/24:0)', 'CE(22:6)', 'PC aa C34:2', 'PC aa C38:3', 'TG(18:2_36:5)',
  'CE(18:2)', 'PC ae C34:1', 'Cer(d16:1/22:0)', 'TG(18:3_34:2)', 'DG(16:1_18:1)',
  'Cer(d18:2/24:0)', 'PC ae C40:1', 'TG(18:0_36:3)', 'Xanthine', 'lysoPC a C17:0',
  'TG(14:0_32:2)', 'PC ae C38:4', 'PC aa C34:1', 'SM C18:0', 'PC aa C32:1',
  'C3-DC (C4-OH)', 'Phe', 'PC ae C36:0', 'PC ae C40:5', 'Cer(d18:0/26:1(OH))', 
  'Anserine', 'Serotonin', 'lysoPC a C16:0', 'TG(18:1_35:2)', 'DG(18:3_18:3)',
  'PC ae C34:2', 'SM C18:1', 'TG(18:2_31:0)', 'PC ae C42:2', 'PC ae C36:1',
  'PC ae C36:3', 'PC ae C36:2', 'DG(18:1_20:3)', 'BABA', 'PC aa C38:6',
  'TG(18:0_32:1)', 'Cer(d18:1/24:1)', 'PC aa C38:4', 'AABA', 'Cer(d18:1/16:0)',
  'PC ae C38:1', 'Cer(d18:0/26:1)', 'PC aa C36:1', 'Cer(d16:1/23:0)',
  'TG(17:1_34:1)', 'lysoPC a C20:4', 'Hex2Cer(d18:1/18:0)', 'DG(18:2_18:2)',
  'TG(18:1_26:0)'
)
```

```{r}
convert_cc_to_mSet <- function(input_data, tmpLocation="tmp/tmp.csv", analysis_type="stat", input_format="rowu", cleanUp=FALSE){

  old_wd <- getwd()
  tmp_dir <- dirname(tmpLocation)
  preexisted_dir <- dir.exists(tmp_dir)
  tmpLocation <- basename(tmpLocation)
  
  if(!preexisted_dir) dir.create(tmp_dir)
  setwd(tmp_dir)

  write_metabodf_tmp(input_data, tmp_out_file=tmpLocation)
  mSet <- populate_mSet(tmpLocation, analysis_type, input_format)
  
  setwd(old_wd)
  if(preexisted_dir){
    if(cleanUp) unlink(tmpLocation)
  } else {
    if(cleanUp) unlink(tmp_dir, recursive=TRUE, force=TRUE)
  }
  
  invisible(mSet)
}

write_metabodf_tmp <- function(metab_data, subject="Subject", condition="Condition", metabolite="Metabolite", value="value", tmp_out_file="tmp.csv"){
  
  metab_data %>%
    select(
      !!sym(subject), !!sym(condition), !!sym(metabolite), !!sym(value)
    )  %>%
    rename(
      Subject = !!sym(subject), Condition = !!sym(condition),
      Metabolite = !!sym(metabolite), value = !!sym(value)
    )  %>%
    pivot_wider(names_from=Metabolite) %>%
    write.csv(tmp_out_file, row.names=FALSE)

}

populate_mSet <- function(analyst_compatible_data, analysis_type="stat", input_format="rowu"){
  
  mSet <- NULL # Have to reset otherwise the app resurrects old instance from global when chunk is rerun
  anal.type <- "stat"
  msg.vec <- list()

  InitDataObjects("conc", analysis_type) %>%
    Read.TextData(analyst_compatible_data, input_format) %>%
    SanityCheckData()

}
```

```{r}
mSet <- NULL
anal.type <- "msetora"
mSet <- InitDataObjects("conc", "msetora", FALSE) %>%
  Setup.MapData(top_roc_m) %>%
  CrossReferencing("name")

mappable_compunds <- mSet$name.map$query.vec[mSet$name.map$match.state == 1]
mappable_compunds
```

```{r}
mSet <- NULL
mSet <- InitDataObjects("conc", "msetora", FALSE) %>%
  Setup.MapData(mappable_compunds) %>%
  CrossReferencing("name") %>%
  CreateMappingResultTable() %>%
  SetMetabolomeFilter(FALSE)
```


```{r}
mSet <- mSet %>%
  SetCurrentMsetLib("smpdb_pathway", 2) %>%
  CalculateHyperScore()
```

```{r}
pw_hit_link <- mSet %>%
  .$analSet %>%
  .$ora.hits %>%
  enframe(name="Pathway", value="Hits") %>%
  unnest(Hits) %>%
  group_by(Pathway) %>%
  mutate(
    Hits = paste(Hits, collapse="; ")
  ) %>%
  ungroup() %>%
  distinct()

pw_hit_link
```

```{r}
pathway_data <- mSet %>%
  .$analSet %>%
  .$ora.mat %>%
  data.frame() %>%
  rownames_to_column("Pathway") %>%
  left_join(pw_hit_link, by="Pathway")

pathway_data
```

```{r}
pathway_data %>%
  arrange(desc(Raw.p)) %>%
  head(15) %>%
  mutate(
    Group = "",
    Pathway = factor(Pathway, levels=unique(.$Pathway))
  ) %>%
  ggplot(aes(x=Group, y=Pathway, size=hits, color=Raw.p)) +
  geom_point() +
  scale_color_gradientn(
    colors=rev(c('#2b8cbe', 'grey', '#e38071', '#e34a33', '#e31e00')),
    breaks=c(0.05, 0.01, 0.001, 0.0001),
    limits=c(0.00001, 1), trans='log10', oob = scales::squish
  ) +
  theme_bw() +
  theme(
    axis.text.x=element_text(angle=30, hjust=1),
    axis.text.y=element_text(size=10)
  ) +
  labs(x="", y="")
```

```{r}
mSet <- NULL
mSet <- convert_cc_to_mSet(metabo_data, analysis_type="msetqea", tmpLocation="./tmp.csv")
```


```{r}
normalize_mSet <- function(inSet, tmpLocation="tmp", cleanUp=FALSE){
  
  old_wd <- getwd()
  if(!dir.exists(tmpLocation)) dir.create(tmpLocation)
  setwd(tmpLocation)

  out <- inSet %>%
    ReplaceMin() %>%
    FilterVariable("iqr", "F", 25) %>%
    PreparePrenormData() %>%
    Normalization("MedianNorm", "LogNorm", "NULL", ratio=FALSE, ratioNum=20)
  
  setwd(old_wd)
  if(cleanUp) unlink(norm_path)

  invisible(out)
}

mSet <- normalize_mSet(mSet)
```


```{r}
mSet <- mSet %>%
  ReplaceMin() %>%
  PreparePrenormData() %>%
  Normalization("MedianNorm", "LogNorm", "NULL", ratio=FALSE, ratioNum=20)
```

```{r}
mSet <- mSet %>%
  CrossReferencing("name") %>%
  CreateMappingResultTable() %>%
  SetMetabolomeFilter(FALSE) %>%
  SetCurrentMsetLib("smpdb_pathway", 2) %>%
  CalculateGlobalTestScore()
```

```{r}
pw_hit_link <- mSet %>%
  .$analSet %>%
  .$qea.hits %>%
  sapply(paste, collapse="; ") %>%
  enframe(name="Pathway", value="Hits")

pathway_data <- mSet %>%
  .$analSet %>%
  .$qea.mat %>%
  data.frame() %>%
  rownames_to_column("Pathway") %>%
  rename(nHits = Hits) %>%
  left_join(pw_hit_link, by="Pathway")

pathway_data
```

```{r}
pathway_data %>%
  arrange(desc(Raw.p)) %>%
  head(15) %>%
  mutate(
    Group = "",
    Pathway = factor(Pathway, levels=unique(.$Pathway))
  ) %>%
  ggplot(aes(x=Group, y=Pathway, size=nHits, color=Raw.p)) +
  geom_point() +
  scale_color_gradientn(
    colors=rev(c('#2b8cbe', 'grey', '#e38071', '#e34a33', '#e31e00')),
    breaks=c(0.05, 0.01, 0.001, 0.0001),
    limits=c(0.00001, 1), trans='log10', oob = scales::squish
  ) +
  theme_bw() +
  theme(
    axis.text.x=element_text(angle=30, hjust=1),
    axis.text.y=element_text(size=10)
  ) +
  labs(x="", y="")
```

```{r}
PlotQEA.Overview(mSet, "msea_bar", "bar", "pdf")
```

```{r}
PlotQEA.Overview(mSet, "msea_net", "net", "pdf")
```

```{r}
api.base <- NULL
mSet <- mSet %>%
  SetKEGG.PathLib("hsa", "current") %>%
  SetMetabolomeFilter(FALSE) %>%
  CalculateOraScore("rbc", "hyperg")
```

## Debug KEGG

```{r}
# Re-initialize mSet

mSet <- NULL
mSet <- convert_cc_to_mSet(metabo_data, analysis_type="pathora") %>%
  normalize_mSet()
```

```{r}
# Find top enriched KEGG pathways in the dataset

mSet <- find_metabo_kegg(mSet, keep_mSet=TRUE)
path_kegg_stats <- mSet$summary_df
```

```{r}
# Show stats for each pathway hit

datatable(path_kegg_stats)
```

```{r}
# Show dot-plot-like figre

p <- plotPathHits(path_kegg_stats)
fig2pdf(p, file.path(local_folder, "example_metabo_msea_dot"))

ggplotly(p)
```

```{r message = FALSE, warning = FALSE}
# Show built-in figure

img_path <- file.path(local_folder, "KEGG_summary_")
mSet <- PlotPathSummary(mSet, TRUE, img_path, "png")
include_graphics(paste(img_path, "dpi72.png", sep=""))
```

```{r message = FALSE, warning = FALSE}
# Show built-in figure

img_path <- file.path(local_folder, "KEGG_hsa00970_")
mSet <- PlotKEGGPath(mSet, "Aminoacyl-tRNA biosynthesis")
include_graphics(paste(img_path, "dpi72.png", sep=""))
```